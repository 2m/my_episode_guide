<script type="text/javascript" src="handles.js"></script>
<script type="text/javascript" src="ShowData.js"></script>
<script>
var showDataHandles = {};

function onLoad() {
    for (i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);
        var showDataEntry = JSON.parse(localStorage.getItem(key));
        showDataHandles[key] = new ShowData(key, showDataEntry.dayOffset, onShowDelete, onGetDaysRemaining).getData();
    }
}

function getShowData(title) {
    return showDataHandles[title];
}

function getNewShowData(title) {
    return new ShowData(title, 0, onShowDelete, onGetDaysRemaining).getData(onNewShowDataParsed);
}

function onNewShowDataParsed(showData) {
    var showDataEntry = {title: showData.title, dayOffset: showData.dayOffset, order: 0};
    localStorage.setItem(showData.id, JSON.stringify(showDataEntry));
    showDataHandles[showData.id] = showData;

    getPopupHandle().addShowToPage(showData);
    getPopupHandle().saveNewOrder();
    getPopupHandle().enableInput();
    getDaysToNextEpisode();
}

function onShowDelete(showData) {
    showDataHandles[showData.title] = null;
    getDaysToNextEpisode();
    getPopupHandle().saveNewOrder();
}

function onGetDaysRemaining(showData) {
    getDaysToNextEpisode();
}

function getDaysToNextEpisode() {

    var nextEpisodeAirsIn = null;
    for (i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);

        if (showDataHandles[key].episodeToShowAirsInDays != null) {
            if (nextEpisodeAirsIn == null || showDataHandles[key].episodeToShowAirsInDays < nextEpisodeAirsIn) {
                nextEpisodeAirsIn = showDataHandles[key].episodeToShowAirsInDays;
            }
        }
    }

    draw(nextEpisodeAirsIn);
}

function draw(nextEpisodeAirsIn) {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    ctx.save();
    ctx.translate(9, 9);

    ctx.font = "bold 10pt Verdana";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    ctx.fillText(nextEpisodeAirsIn == null ? "??" : nextEpisodeAirsIn, 0, 0);

    chrome.browserAction.setIcon({imageData:ctx.getImageData(0, 0, 18, 18)});
    ctx.restore();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}
</script>
<body onload="onLoad()">
    <canvas id="canvas" width="18" height="18" style="border: black 2px solid; display:none"></canvas>
</body>